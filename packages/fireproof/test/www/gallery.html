<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fireproof Uploads</title>
  <script src="../../dist/browser/fireproof.iife.js?cache=7840"></script>
  <script type="text/javascript">
    function testApp() {
      const { connect, fireproof, index } = Fireproof;
      let dbName
      let db
      let connection

      let cancelRefresh

      function setupDb(name) {
        if (cancelRefresh) {
          cancelRefresh()
        }
        dbName = name;
        db = fireproof(name);
        window.db = db;
        // connection = connect.s3(db, s3Info)

        connection = db.connect("jchris+gallery10@fireproof.storage", "files")
        window.connection = connection
        cancelRefresh = autoRefresh()

        db.subscribe(redraw);
        return db;
      }
      // const s3Info = {
      //   upload: 'https://04rvvth2b4.execute-api.us-east-2.amazonaws.com/uploads',
      //   download: 'https://sam-app-s3uploadbucket-e6rv1dj2kydh.s3.us-east-2.amazonaws.com'
      // }

      let doing
      const redraw = async () => {
        if (doing) {
          return doing
        }
        doing = draw().finally(() => doing = null)
        return doing
      }

      const draw = async () => {
        const result = await db.query('_id', { descending: true, limit: 10 })
        // console.log('result', result)
        document
          .querySelector('ul')
          .innerHTML = '';
        for (const row of result.rows) {
          const doc = row.doc
          if (doc._files) {
            const li = document
              .querySelector('ul')
              .appendChild(document.createElement('li'))
            li.appendChild(document.createElement('span')).innerText = row.key;
            li.appendChild(document.createElement('br'))
            // let didDoc = 0
            for (const file of Object.keys(doc._files)) {
              (async () => {
                // if (didDoc) { return }
                const meta = doc._files[file]
                if (meta.file && /image/.test(meta.type)) {
                  // console.log('file', `https://${meta.cid}.ipfs.w3s.link/`)
                  const src = URL.createObjectURL(await meta.file());
                  // didDoc++
                  // console.log('src', src.toString())
                  const img = document.createElement("img");
                  img.src = src
                  img.height = 100;
                  img.onload = () => {
                    URL.revokeObjectURL(img.src);
                  };
                  li.appendChild(img);
                }
              })();
            }
          }

        }
      }



      let autoCancelled = false
      async function autoRefresh() {
        if (autoCancelled) {
          autoCancelled = false
          return
        }
        // console.log('autoRefresh')
        connection.refresh().then(() => {
          setTimeout(autoRefresh, 2000);
        }).catch((err) => {
          console.log('refresh err', err)
          setTimeout(autoRefresh, 10000);
        })
        return () => autoCancelled = true
      }



      async function changeList(e) {
        e.preventDefault();
        const input = document.querySelector('#list');
        dbName = input.value;
        history.pushState(null, '', location.pathname + '?db=' + encodeURIComponent(dbName));
        setupDb(dbName);

        redraw();
      }
      window.changeList = changeList;

      async function openDashboard(e) {
        e.preventDefault();
        db.openDashboard();
      }
      window.openDashboard = openDashboard;


      function handleFiles() {
        const fileList = this.files;
        const doc = {
          _files: {}
        }
        for (const file of fileList) {
          doc._files[file.name] = file
        }
        const ok = db.put(doc);
      }

      async function initialize() {
        ps = new URLSearchParams(location.search)
        const listQ = ps.get('db')
        setupDb(listQ || 'hello-world');
        const input = document.querySelector('#list');
        input.value = dbName;

        const inputElement = document.getElementById("files-up");
        inputElement.addEventListener("change", handleFiles, false);
        db.subscribe(draw);
        draw()
      }

      window.onload = initialize;

    }
    testApp();
  </script>
</head>

<body>
  List:
  <input title="gallery" type="text" name="list" id="list" />
  <button onclick="changeList(event)">Change Gallery</button>
  <button onclick="doRefresh(event)">Refresh</button>
  <button onclick="openDashboard(event)">ðŸ”¥ Import to Dashboard</button>
  <h3>Files</h3>
  <p>Data is stored locally and encrypted before upload to S3.
    This is a demo so the encryption key is not managed securely.
    Read more about <a href="https://use-fireproof.com/docs/database-api/replication">Fireproof
      replication options.</a> You can also see a demo without images but <a
      href="https://fireproof.storage/s3up-test.html">with
      compaction and refresh buttons.</a>
  </p>
  <label for="files-up"><strong>Drop files:</strong></label>
  <input accept="image/*" title="save to Fireproof" type="file" id="files-up" multiple>
  <ul></ul>
</body>

</html>