<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fireproof Test</title>
  <script src="./fireproof.iife.js?123"></script>
  <script type="text/javascript">
    function todoApp() {
      const actorTag = Math.random().toString(36).substring(2, 7)
      const { connect, fireproof, index } = Fireproof;
      let dbName
      let db
      let cx

      let dbUnsubscribe = false

      function setupDb(name) {
        const input = document.querySelector('#todo');
        input.disabled = true

        if (dbUnsubscribe) {
          dbUnsubscribe()
        }
        dbName = name;
        db = fireproof(name);
        window.db = db;

        cx = db.connect("jchris+todos-29@fireproof.storage", "todo-test")
        window.cx = cx

        cx.ready.then(() => {
          console.log('ready')
          input.disabled = false
        }).catch((e) => {
          console.log('not ready', e)
        })

        dbUnsubscribe = db.subscribe(redraw);
        return db;
      }

      let doing
      const redraw = async () => {
        if (doing) {
          return doing
        }
        doing = doRedraw().finally(() => doing = null)
        return doing
      }

      const doRedraw = async () => {
        const result = await index(db, 'created').query({ includeDocs: false });
        document
          .querySelector('ul')
          .innerHTML = '';

        for (const row of result.rows) {
          const doc = await db.get(row.id);
          // doc = row.doc
          const checkbox = document.createElement('input');
          checkbox.setAttribute('type', 'checkbox');
          if (doc.completed) {
            checkbox.setAttribute('checked', true);
          }
          checkbox.onchange = async (e) => {
            e.target.indeterminate = true;
            doc.completed = !doc.completed;
            console.log('putting', doc.task, doc.completed)
            await db.put(doc);
            console.log('put', doc.task, doc.completed)
          }
          const textSpan = document.createElement('span');
          textSpan.innerText = doc.actor + ': ' + doc.task;
          const li = document.createElement('li');
          li.appendChild(checkbox);
          li.appendChild(textSpan);
          document
            .querySelector('ul')
            .appendChild(li);
        }
      }

      async function initialize() {
        ps = new URLSearchParams(location.search)
        const listQ = ps.get('list')
        setupDb(listQ || 'my-list');
        const input = document.querySelector('#list');
        input.value = dbName;
        redraw()
      }

      async function openDashboard(e) {
        db.openDashboard();
      }
      window.openDashboard = openDashboard;

      async function changeList(e) {
        e.preventDefault();
        const input = document.querySelector('#list');
        dbName = input.value;
        history.pushState(null, '', location.pathname + '?list=' + encodeURIComponent(dbName));
        setupDb(dbName);

        redraw();
      }
      window.changeList = changeList;

      async function onButtonClick(e) {
        e.preventDefault();

        const input = document.querySelector('#todo');
        const ok = await db.put({ actor: actorTag, created: Date.now(), task: input.value, completed: false });
        input.value = '';

      }
      window.onButtonClick = onButtonClick;

      async function doCompact(e) {
        e.preventDefault();
        await db.compact()
        document
          .querySelector('#filecount')
          .innerText = db._crdt.blocks.loader.carLog.length
      }
      window.doCompact = doCompact;

      window.onload = initialize;
      window.db = db;
      window.redraw = redraw;
    }
    todoApp();
  </script>
</head>

<body>
  <h1>Fireproof Todos</h1>
  List:
  <input type="text" name="list" id="list" />
  <button onclick="changeList(event)">Change List</button>
  <button disabled onclick="openDashboard(event)">ðŸ”¥ Import to Dashboard</button>
  <p>Work locally or verify your email address to sync.</p>
  Email: <input title="email" placeholder="name@example.com" name="email" id="email" />
  <button onclick="verifyEmail(event)">Verify email</button>

  <p>
    Fireproof stores data locally and encrypts it before sending it to the cloud.
    This demo uses web3.storage, but you can easily run Fireproof on S3 or another provider.
    <a href="https://use-fireproof.com/">Learn more in the Fireproof developer docs.</a>
  </p>

  <h3>Todos</h3>
  <input type="text" name="todo" id="todo" />
  <button onclick="onButtonClick(event)">Create Todo</button>
  <ul></ul>
</body>

</html>