# Fireproof Cloud - Local Development Stack
#
# Quick Start:
#   1. Copy .env.docker to .env: cp .env.docker .env
#   2. Run: docker compose up --build
#
# Services:
# - cloud-backend: Wrangler dev with R2 storage (port 8909)
# - dashboard: Dashboard frontend + API (port 7370)
# - todo-app: 3rd-party example application (port 5174)
#
# Storage:
# - R2 blob storage via wrangler dev (no MinIO needed)
# - Data persisted in wrangler_state volume
#
# For a faster dev experience (infrastructure only):
#   docker compose -f docker-compose.infra.yaml up

services:
  # Cloud Backend (Wrangler dev with R2 storage)
  cloud-backend:
    build:
      context: .
      dockerfile: docker/Dockerfile.cloud-backend
    container_name: fireproof-cloud-backend
    ports:
      - "8909:8909"
    environment:
      # Server config
      ENDPOINT_PORT: "8909"
      NODE_ENV: development

      # Session tokens (set in .env file)
      CLOUD_SESSION_TOKEN_PUBLIC: ${CLOUD_SESSION_TOKEN_PUBLIC:-your-cloud-session-token-public}

      # Protocol settings
      VERSION: FP-MSG-1.0
      FP_DEBUG: "true"
      MAX_IDLE_TIME: "300"
    volumes:
      - wrangler_state:/app/.wrangler
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8909/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Dashboard (Frontend + Backend API)
  dashboard:
    build:
      context: .
      dockerfile: docker/Dockerfile.dashboard
    container_name: fireproof-dashboard
    ports:
      - "7370:7370"
    environment:
      # Server config
      PORT: "7370"
      NODE_ENV: development
      ENVIRONMENT: dev

      # Session tokens (must match cloud-backend, set in .env file)
      CLOUD_SESSION_TOKEN_PUBLIC: ${CLOUD_SESSION_TOKEN_PUBLIC:-your-cloud-session-token-public}
      CLOUD_SESSION_TOKEN_SECRET: ${CLOUD_SESSION_TOKEN_SECRET:-your-cloud-session-token-secret}

      # Clerk authentication (set in .env file)
      CLERK_SECRET_KEY: ${CLERK_SECRET_KEY:-your-clerk-secret-key}
      CLERK_PUBLISHABLE_KEY: ${CLERK_PUBLISHABLE_KEY:-your-clerk-publishable-key}
      VITE_CLERK_PUBLISHABLE_KEY: ${VITE_CLERK_PUBLISHABLE_KEY:-your-clerk-publishable-key}
      CLERK_PUB_JWT_URL: ${CLERK_PUB_JWT_URL:-https://your-clerk-domain.clerk.accounts.dev}

      # Device ID CA (set in .env file)
      DEVICE_ID_CA_PRIV_KEY: ${DEVICE_ID_CA_PRIV_KEY:-your-device-id-ca-private-key}
      DEVICE_ID_CA_CERT: ${DEVICE_ID_CA_CERT:-your-device-id-ca-cert}

      # Limits
      MAX_LEDGERS: "50"
      MAX_TENANTS: "100"
      MAX_ADMIN_USERS: "10"
      MAX_MEMBER_USERS: "50"
      MAX_INVITES: "100"
      MAX_APPID_BINDINGS: "50"

      # Cloud backend URL
      FP_ENDPOINT: http://cloud-backend:8909
    depends_on:
      cloud-backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:7370/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 3rd-Party App (Example Application)
  todo-app:
    build:
      context: .
      dockerfile: docker/Dockerfile.todo-app
      args:
        VITE_DASHBOARD_URI: http://localhost:7370/fp/cloud/api/token
        VITE_TOKEN_API_URI: http://localhost:7370/api
        VITE_CLOUD_BACKEND_URL: fpcloud://localhost:8909?protocol=ws
    container_name: fireproof-todo-app
    ports:
      - "5174:80"
    depends_on:
      dashboard:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Nginx Reverse Proxy
  proxy:
    image: nginx:alpine
    container_name: fireproof-proxy
    ports:
      - "8080:8080"
    volumes:
      - ./docker/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      cloud-backend:
        condition: service_healthy
      dashboard:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:8080/proxy/health"]
      interval: 10s
      timeout: 5s
      retries: 3

volumes:
  wrangler_state:

networks:
  default:
    name: fireproof-network
