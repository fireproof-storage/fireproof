name: "dashboard-base"
description: "Dashboard-Base Compile & Test Action"
inputs:
  CLOUDFLARE_API_TOKEN:
    description: "Cloudflare API token for authentication"
    required: true
  CLOUDFLARE_ACCOUNT_ID:
    description: "Cloudflare account ID"
    required: true
  CLOUDFLARE_D1_TOKEN:
    description: "Cloudflare D1 token for database access"
    required: true
  CLOUDFLARE_DATABASE_ID:
    description: "Cloudflare database ID"
    required: true
  CLOUD_SESSION_TOKEN_PUBLIC:
    description: "Public session token for cloud authentication"
    required: true
  CLOUD_SESSION_TOKEN_SECRET:
    description: "Secret session token for cloud authentication"
    required: true
  CLERK_PUBLISHABLE_KEY:
    description: "Clerk publishable key"
    required: true
  CLERK_PUB_JWT_URL:
    description: "Clerk public JWT URL could be comma separated for multiple"
    required: true
  CLERK_PUB_JWT_KEY:
    description: "Clerk public JWT key if your key is not fetchable singleline PEM,JSON, its totally fine to have multiple keys"
    required: false
  CLOUDFLARE_ENV:
    description: "Cloudflare environment (e.g., production, staging)"
    required: true
  MAX_TENANTS:
    description: "default for max tenants per new user"
  MAX_ADMIN_USERS:
    description: "default for max admin user for a tenant"
  MAX_MEMBER_USERS:
    description: "default for max member users for a tenant"
  MAX_INVITES:
    description: "default how many invitest could be created per tenant"
  MAX_LEDGERS:
    description: "default how many ledgers per tenant are allowed"
  DEVICE_ID_CA_PRIV_KEY:
    description: "Device ID Certificate Authority private key"
    required: false
  DEVICE_ID_CA_CERT:
    description: "Device ID Certificate Authority certificate"
    required: false

runs:
  using: "composite"
  steps:
    - name: Deploy Dashboard
      working-directory: dashboard/frontend
      shell: bash
      env:
        # need for drizzle
        CLOUDFLARE_API_TOKEN: ${{ inputs.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ inputs.CLOUDFLARE_ACCOUNT_ID }}
        CLOUDFLARE_D1_TOKEN: ${{ inputs.CLOUDFLARE_D1_TOKEN }}
        CLOUDFLARE_DATABASE_ID: ${{ inputs.CLOUDFLARE_DATABASE_ID }}
        # need in CF to be Env
        CLOUDFLARE_ENV: ${{ inputs.CLOUDFLARE_ENV }}
        CLOUD_SESSION_TOKEN_PUBLIC: ${{ inputs.CLOUD_SESSION_TOKEN_PUBLIC }}
        CLOUD_SESSION_TOKEN_SECRET: ${{ inputs.CLOUD_SESSION_TOKEN_SECRET }}
        CLERK_PUBLISHABLE_KEY: ${{ inputs.CLERK_PUBLISHABLE_KEY }}
        CLERK_PUB_JWT_KEY: ${{ inputs.CLERK_PUB_JWT_KEY }}
        CLERK_PUB_JWT_URL: ${{ inputs.CLERK_PUB_JWT_URL }}
        MAX_TENANTS: ${{ inputs.MAX_TENANTS }}
        MAX_ADMIN_USERS: ${{ inputs.MAX_ADMIN_USERS }}
        MAX_MEMBER_USERS: ${{ inputs.MAX_MEMBER_USERS }}
        MAX_INVITES: ${{ inputs.MAX_INVITES }}
        MAX_LEDGERS: ${{ inputs.MAX_LEDGERS }}
        DEVICE_ID_CA_PRIV_KEY: ${{ inputs.DEVICE_ID_CA_PRIV_KEY }}
        DEVICE_ID_CA_CERT: ${{ inputs.DEVICE_ID_CA_CERT }}
        # need during build
        VITE_CLERK_PUBLISHABLE_KEY: ${{ inputs.CLERK_PUBLISHABLE_KEY }}
      run: |
        (cd ../backend && pnpm run drizzle:d1-remote)
        pnpm exec core-cli wellKnown --jsons --presetKey "$CLERK_PUB_JWT_KEY" "$CLERK_PUB_JWT_URL" > key
        CLERK_PUB_JWT_KEY="$(cat key)"
        pnpm exec core-cli writeEnv --env ${{inputs.CLOUDFLARE_ENV}} --out /dev/stdout --json \
          --fromEnv CLERK_PUBLISHABLE_KEY \
          --fromEnv CLERK_PUB_JWT_URL \
          --fromEnv CLERK_PUB_JWT_KEY \
          --fromEnv MAX_ADMIN_USERS \
          --fromEnv MAX_INVITES \
          --fromEnv MAX_LEDGERS \
          --fromEnv MAX_MEMBER_USERS \
          --fromEnv MAX_TENANTS \
          --fromEnv CLOUD_SESSION_TOKEN_SECRET \
          --fromEnv CLOUD_SESSION_TOKEN_PUBLIC \
          --fromEnv DEVICE_ID_CA_PRIV_KEY \
          --fromEnv DEVICE_ID_CA_CERT | \
          pnpm exec wrangler -c ../backend/wrangler.toml secret --env ${{inputs.CLOUDFLARE_ENV}} bulk
        pnpm run deploy:cf --env ${{inputs.CLOUDFLARE_ENV}}
