name: "@fireproof/core-publish"
description: "setup  runtime"
inputs:
  NPM_TOKEN:
    description: "NPM token for publishing packages"
    required: true
# your inputs here
runs:
  using: "composite"
  steps:
    - name: publish
      shell: bash
      env:
        NPM_TOKEN: ${{ inputs.NPM_TOKEN }}
      run: |
        rm -f **/.npmrc # publish to the world
        git fetch --tags --force
        # we need to have a safe way to store of allowedSigners
        git config --local --add gpg.ssh.allowedSignersFile ./allowed_signers
        echo "GITHUB_REF->"$GITHUB_REF
        # test tag signature
        git tag -v $(git describe --tags --abbrev=0)
        # should only run if a tag is set
        echo "//registry.npmjs.org/:_authToken=${{ inputs.NPM_TOKEN }}" > ~/.npmrc
        mkdir -p dist
        echo "//registry.npmjs.org/:_authToken=${{ inputs.NPM_TOKEN }}" > dist/npmrc-smoke
        
        # Extract version from tag and determine npm tag
        TAG_NAME=$(git describe --tags --abbrev=0)
        VERSION=${TAG_NAME#*@v}  # Remove prefix up to @v
        if [[ "$VERSION" == *"-"* ]]; then
          # Version contains dash (pre-release) - publish to 'dev' tag
          NPM_TAG="dev"
          echo "Publishing pre-release version $VERSION to 'dev' tag"
        else
          # Version has no dash (stable release) - publish to 'latest' tag
          NPM_TAG="latest"
          echo "Publishing stable version $VERSION to 'latest' tag"
        fi
        
        pnpm run publish --registry https://registry.npmjs.org/ --tag $NPM_TAG
